using Skyware.Arenal.Validation;
using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;

namespace Skyware.Arenal.Model;


/// <summary>
/// Medical order for laboratory examination/observation or service.
/// </summary>
public class Order : EntityBase
{

    /// <summary>
    /// Maximum allowed length for local identifiers of the order.
    /// </summary>
    public const int MAX_ORDER_LOCAL_ID = 50;

    /// <summary>
    /// Maximum number of linked referrals.
    /// </summary>
    public const int MAX_LINKED_REFERRALS = 15;

    private static OrderValidator _validator;

    /// <summary>
    /// Identifies Arenal workflow.
    /// </summary>
    [Display(GroupName = nameof(L10n.Order.Order.GeneralGroup), ShortName = nameof(L10n.Order.Order.WorkflowShortName), Name = nameof(L10n.Order.Order.WorkflowName),
        Description = nameof(L10n.Order.Order.WorkflowDescription),
        Prompt = nameof(L10n.Order.Order.WorkflowPrompt), ResourceType = typeof(L10n.Order.Order))]
    public string Workflow { get; set; }

    /// <summary>
    /// ArenalId of the ordering party. Set by Arenal.
    /// </summary>
    [Display(GroupName = nameof(L10n.Order.Order.OrdererGroup), ShortName = nameof(L10n.Order.Order.PlacerIdShortName), Name = nameof(L10n.Order.Order.PlacerIdName),
        Description = nameof(L10n.Order.Order.PlacerIdDescription),
        Prompt = nameof(L10n.Order.Order.PlacerIdPrompt), ResourceType = typeof(L10n.Order.Order))]
    public string PlacerId { get; set; }

    /// <summary>
    /// ArenalId of the service provider to which this order is intended (conditional).
    /// In 'open' workflows, the identifier is generated by the party which takes the order.
    /// </summary>
    [Display(GroupName = nameof(L10n.Order.Order.ProviderGroup), ShortName = nameof(L10n.Order.Order.ProviderIdShortName), Name = nameof(L10n.Order.Order.ProviderIdName),
        Description = nameof(L10n.Order.Order.ProviderIdDescription),
        Prompt = nameof(L10n.Order.Order.ProviderIdPrompt), ResourceType = typeof(L10n.Order.Order))]
    public string ProviderId { get; set; }

    /// <summary>
    /// Placer's order identifier (optional). This is the identifier generated by the party which places the order.
    /// </summary>
    [Display(GroupName = nameof(L10n.Order.Order.OrdererGroup), ShortName = nameof(L10n.Order.Order.PlacerOrderShortName), Name = nameof(L10n.Order.Order.PlacerOrderName),
        Description = nameof(L10n.Order.Order.PlacerOrderDescription),
        Prompt = nameof(L10n.Order.Order.PlacerOrderPrompt), ResourceType = typeof(L10n.Order.Order))]
    public string PlacerOrderId { get; set; }

    /// <summary>
    /// Filler's order identifier (optional). This is the identifier generated by the party which consumes the order.
    /// </summary>
    [Display(GroupName = nameof(L10n.Order.Order.ProviderGroup), ShortName = nameof(L10n.Order.Order.ProviderOrderShortName), Name = nameof(L10n.Order.Order.ProviderOrderName),
        Description = nameof(L10n.Order.Order.ProviderOrderDescription),
        Prompt = nameof(L10n.Order.Order.ProviderOrderPrompt), ResourceType = typeof(L10n.Order.Order))]
    public string ProviderOrderId { get; set; }

    /// <summary>
    /// Date and time the order was created (UTC).
    /// </summary>
    [Display(GroupName = nameof(L10n.Order.Order.GeneralGroup), ShortName = nameof(L10n.Order.Order.CreatedShortName),
        Name = nameof(L10n.Order.Order.CreatedName),
        Description = nameof(L10n.Order.Order.CreatedDescription), ResourceType = typeof(L10n.Order.Order))]
    public DateTime? Created { get; set; }

    /// <summary>
    /// Date and time the order was created (Local date and time).
    /// </summary>
    [Display(GroupName = nameof(L10n.Order.Order.GeneralGroup), ShortName = nameof(L10n.Order.Order.CreatedShortName),
        Name = nameof(L10n.Order.Order.LocalCreatedName),
        Description = nameof(L10n.Order.Order.LocalCreatedDescription), ResourceType = typeof(L10n.Order.Order))]
    public DateTime? LocalCreated { get => Created?.ToLocalTime(); }

    /// <summary>
    /// Date and time the order was last modified (UTC).
    /// </summary>
    [Display(GroupName = nameof(L10n.Order.Order.GeneralGroup), ShortName = nameof(L10n.Order.Order.Modified), Name = nameof(L10n.Order.Order.ModifiedName),
        Description = nameof(L10n.Order.Order.ModifiedDescription), ResourceType = typeof(L10n.Order.Order))]
    public DateTime? Modified { get; set; }

    /// <summary>
    /// Date and time the order was last modified (Local date and time).
    /// </summary>
    [Display(GroupName = nameof(L10n.Order.Order.GeneralGroup), ShortName = nameof(L10n.Order.Order.Modified), Name = nameof(L10n.Order.Order.LocalModifiedName),
        Description = nameof(L10n.Order.Order.LocalModifiedDescription), ResourceType = typeof(L10n.Order.Order))]
    public DateTime? LocalModified { get => Modified?.ToLocalTime(); }

    /// <summary>
    /// Version (server generated), starts from 0 and increments on every update from the publisher side.
    /// </summary>
    [Display(GroupName = nameof(L10n.Order.Order.GeneralGroup), ShortName = nameof(L10n.Order.Order.VersionShortName),
        Name = nameof(L10n.Order.Order.VersionName),
        Description = nameof(L10n.Order.Order.VersionDescription), ResourceType = typeof(L10n.Order.Order))]
    public int Version { get; set; } = 0;

    /// <summary>
    /// Date and time when the order is taken or rejected by the provider (UTC).
    /// </summary>
    [Display(GroupName = nameof(L10n.Order.Order.GeneralGroup), ShortName = nameof(L10n.Order.Order.TakenOrRejectedShortName),
        Name = nameof(L10n.Order.Order.TakenOrRejectedName),
        Description = nameof(L10n.Order.Order.TakenOrRejectedDescription), ResourceType = typeof(L10n.Order.Order))]
    public DateTime? TakenOrRejected { get; set; }

    /// <summary>
    /// Date and time when the order is taken or rejected by the provider (Local date and time).
    /// </summary>
    [Display(GroupName = nameof(L10n.Order.Order.GeneralGroup), ShortName = nameof(L10n.Order.Order.LocalTakenOrRejectedShortName),
        Name = nameof(L10n.Order.Order.LocalTakenOrRejectedName),
        Description = nameof(L10n.Order.Order.LocalTakenOrRejectedDescription), ResourceType = typeof(L10n.Order.Order))]
    public DateTime? LocalTakenOrRejected { get => TakenOrRejected?.ToLocalTime(); }

    /// <summary>
    /// Order status, according to <see cref="OrderStatuses"/>.
    /// </summary>
    [Display(GroupName = nameof(L10n.Order.Order.GeneralGroup), 
        ShortName = nameof(L10n.Order.Order.StatusShortName),
        Name = nameof(L10n.Order.Order.StatusName),
        Description = nameof(L10n.Order.Order.StatusDescription),
        Prompt = nameof(L10n.Order.Order.StatusPrompt), 
        ResourceType = typeof(L10n.Order.Order))]
    public string Status { get; set; } = OrderStatuses.AVAILABLE; 

    /// <summary>
    /// Notes from the placer.
    /// </summary>
    [Display(GroupName = nameof(L10n.Order.Order.PlacerNoteGroup), 
        ShortName = nameof(L10n.Order.Order.PlacerNoteShortName),
        Name = nameof(L10n.Order.Order.PlacerNoteName),
        Description = nameof(L10n.Order.Order.PlacerNoteDescription),
        Prompt = nameof(L10n.Order.Order.PlacerNotePrompt),
        ResourceType = typeof(L10n.Order.Order))]
    public Note PlacerNote { get; set; }

    /// <summary>
    /// Notes from the provider.
    /// </summary>
    [Display(GroupName = nameof(L10n.Order.Order.ProviderNoteGroup),
        ShortName = nameof(L10n.Order.Order.ProviderNoteShortName),
        Name = nameof(L10n.Order.Order.ProviderNoteName),
        Description = nameof(L10n.Order.Order.ProviderNoteDescription),
        Prompt = nameof(L10n.Order.Order.ProviderNotePrompt),
        ResourceType = typeof(L10n.Order.Order))]
    public Note ProviderNote { get; set; }

    /// <summary>
    /// Ordering doctor.
    /// </summary>
    [Display(GroupName = nameof(L10n.Order.Order.DoctorGroupName),
        ShortName = nameof(L10n.Order.Order.DoctorShortName),
        Name = nameof(L10n.Order.Order.DoctorName),
        Description = nameof(L10n.Order.Order.DoctorDescription),
        Prompt = nameof(L10n.Order.Order.DoctorPrompt),
        ResourceType = typeof(L10n.Order.Order))]
    public Doctor Doctor { get; set; }

    /// <summary>
    /// Patient.
    /// </summary>
    [Display(GroupName = nameof(L10n.Order.Order.PatientGroupName),
        ShortName = nameof(L10n.Order.Order.PatientShortName),
        Name = nameof(L10n.Order.Order.PatientName),
        Description = nameof(L10n.Order.Order.PatientDescription),
        Prompt = nameof(L10n.Order.Order.PatientPrompt),
        ResourceType = typeof(L10n.Order.Order))]
    public Patient Patient { get; set; }

    /// <summary>
    /// Additional orders or referrals, which are part of this order and ares stored and processed in external systems.
    /// </summary>
    [Display(GroupName = nameof(L10n.Order.Order.LinkedReferralsGroupName),
        ShortName = nameof(L10n.Order.Order.LinkedReferralsShortName),
        Name = nameof(L10n.Order.Order.LinkedReferralsName),
        Description = nameof(L10n.Order.Order.LinkedReferralsDescription),
        Prompt = nameof(L10n.Order.Order.LinkedReferralsPrompt),
        ResourceType = typeof(L10n.Order.Order))]
    public IList<LinkedReferral> LinkedReferrals { get; set; }

    /// <summary>
    /// Unique collection of requested examinations or observations.
    /// </summary>
    /// <remarks>
    /// Uniqueness is imposed on equality on <see cref="Service.ServiceId"/>.
    /// See <see cref="Identifier"/> for details.
    /// </remarks>
    [Display(GroupName = nameof(L10n.Order.Order.ServicesGroupName),
        ShortName = nameof(L10n.Order.Order.ServicesShortName),
        Name = nameof(L10n.Order.Order.ServicesName),
        Description = nameof(L10n.Order.Order.ServicesDescription),
        Prompt = nameof(L10n.Order.Order.ServicesPrompt),
        ResourceType = typeof(L10n.Order.Order))]
    public IList<Service> Services { get; set; }

    /// <summary>
    /// Unique collection of provided samples (conditional).
    /// </summary>
    /// <remarks>
    /// Uniqueness is imposed on equality on <see cref="Sample.SampleId"/> (the barcode).
    /// </remarks>
    [Display(GroupName = nameof(L10n.Order.Order.SamplesGroupName),
        ShortName = nameof(L10n.Order.Order.SamplesShortName),
        Name = nameof(L10n.Order.Order.SamplesName),
        Description = nameof(L10n.Order.Order.SamplesDescription),
        Prompt = nameof(L10n.Order.Order.SamplesPrompt),
        ResourceType = typeof(L10n.Order.Order))]
    public IList<Sample> Samples { get; set; }

    /// <summary>
    /// Order related files.
    /// </summary>
    [Display(GroupName = nameof(L10n.Order.Order.AttachmentsGroupName),
        ShortName = nameof(L10n.Order.Order.AttachmentsShortName),
        Name = nameof(L10n.Order.Order.AttachmentsName),
        Description = nameof(L10n.Order.Order.AttachmentsDescription),
        Prompt = nameof(L10n.Order.Order.AttachmentsPrompt),
        ResourceType = typeof(L10n.Order.Order))]
    public IList<Attachment> Attachments { get; set; }

    /// <summary>
    /// Default constructor.
    /// </summary>
    public Order() : base() { }

    /// <summary>
    /// Instantiates minimal valid order.
    /// </summary>
    /// <param name="workflow"></param>
    /// <param name="placerId"></param>
    /// <param name="patient"></param>
    /// <param name="services"></param>
    /// <param name="samples"></param>
    /// <param name="providerId"></param>
    public Order(string workflow, string placerId, Patient patient, IList<Service> services = null, IList<Sample> samples = null, string providerId = null) : this()
    {
        Workflow = workflow;
        Patient = patient;
        PlacerId = placerId;
        if (services is not null) Services = services;
        if (samples is not null) Samples = samples;
        if (!string.IsNullOrWhiteSpace(providerId)) ProviderId = providerId;
    }

    /// <summary>
    /// Convenience method for setting <see cref="Order.Patient"/> property.
    /// </summary>
    /// <param name="patient"></param>
    /// <returns></returns>
    public Order SetPatient(Patient patient)
    {
        Patient = patient;
        return this;
    }

    /// <summary>
    /// Safely adds a <see cref="Sample"/> to the order.
    /// </summary>
    /// <param name="sample">A <see cref="Sample"/> to add</param>
    public Order AddSample(Sample sample)
    {
        Samples ??= new List<Sample>();
        Samples.Add(sample);
        return this;
    }

    /// <summary>
    /// Safely adds a <see cref="Sample"/> to the order.
    /// </summary>
    /// <param name="sampleTypeCode"></param>
    /// <param name="barcode"></param>
    /// <param name="taken"></param>
    /// <param name="note"></param>
    /// <param name="additiveCode"></param>
    public Order AddSample(string sampleTypeCode, string additiveCode, string barcode, DateTime? taken = null, string note = null)
    {
        Samples ??= new List<Sample>();
        Samples.Add(new Sample(sampleTypeCode, additiveCode, barcode, taken, note));
        return this;
    }

    /// <summary>
    /// Safely adds a <see cref="Service"/> to the order.
    /// </summary>
    /// <param name="service">A <see cref="Service"/> to add</param>
    public Order AddService(Service service)
    {
        Services ??= new List<Service>();
        Services.Add(service);
        return this;
    }

    /// <summary>
    /// Safely adds a <see cref="Service"/> to the order.
    /// </summary>
    /// <param name="serviceCode">LOINC code for service to add</param>
    /// <param name="name">Name of the service to add</param>
    /// <param name="note">A note to the service</param>
    public Order AddService(string serviceCode, string name = null, string note = null)
    {
        Services ??= new List<Service>();
        Services.Add(new Service(serviceCode, name, note));
        return this;
    }

    /// <summary>
    /// Validates the order against business logic.
    /// </summary>
    /// <returns></returns>
    public FluentValidation.Results.ValidationResult Validate()
    {
        return (_validator ??= new OrderValidator()).Validate(this);
    }

}

